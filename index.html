<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>reveal.js – The HTML Presentation Framework</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Templating serveur<br>&amp; composants front</h1>
					<h3>L'impossible amour ?</h3>
					<p>
						<small>
							Nicolas Grisey Demengel, developer @hopwork
						</small>
					</p>
					<p>
						<small>
							<a href="http://demengel.net">demengel.net</a> /
							<a href="http://twitter.com/nicolasdemengel">@NicolasDemengel</a> /
							<a href="http://twitter.com/moreunit">@moreunit</a>
						</small>
					</p>
				</section>

				<section>
					<h2>Templating coté serveur ou client ?</h2>
					<ul>
						<li class="fragment">app dans le browser</li>
						<li class="fragment">premier rendu</li>
						<li class="fragment">version dégradée</li>
						<li class="fragment">etc.</li>
					</ul>
				</section>

				<section>
					<h2>Notre problème</h2>
					<ul>
						<li>templates JSP</li>
						<li>composants JS</li>
						<li>comment tester ça facilement ?</li>
					</ul>
				</section>

				<section>
					<section>
						<h2>Si on était full JS...</h2>
						<p>Mocha, chai, jsdom, et voilà !</p>
					</section>
					<section>
						<h2>Si on était full JS...</h2>
						<p>Une vue</p>
						<pre><code class="hljs" data-trim>
var View = require('ampersand-view');
var templates = require('./templates');

module.exports = View.extend({

  template: templates.myView,

  events: {
    'click .foo': 'doSomething'
  },

  doSomething: function () {
    this.trigger('some-custom-event');
  }
});
						</code></pre>
					</section>
					<section>
						<h2>Si on était full JS...</h2>
						<p>Un test</p>
						<pre><code class="hljs" data-trim>
describe('MyView', function () {
  it('should xxx when yyy', withDocument(function () {
    // given
    var MyView = require('../src/my-view');
    var view = new MyView({ /* some args */ }).render();

    var listener = sinon.spy();
    view.on('some-custom-event', listener);

    // when
    $('.foo').click();
    // then
    listener.should.have.been.calledWith(view);
  }));
});
						</code></pre>
					</section>
					<section>
						<h2>Mais on utilise des JSP</h2>
						<pre><code class="hljs xml" data-trim>
&lt;c:if test="${1 == 2}"&gt;ben non&lt;/c:if&gt;

&lt;c:forEach items="${things}" var="thing"&gt;
  ${thing}
  &lt;c:out value="${thing}"/&gt;
&lt;/c:forEach&gt;

&lt;spring:message code="my.message.key"/&gt;

&lt;form:input type="number" path="description"/&gt;

&lt;jsp:include page="other.jsp"&gt;
  &lt;jsp:param name="foo" value="bar"/&gt;
&lt;/jsp:include&gt;
						</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h2>Et si...</h2>
						<ol>
							<li class="fragment">
								Interpréteur de JSP en JS, anyone ?
								<br><span class="fragment">Pas trouvé :-( &nbsp;&nbsp;&nbsp;(en même temps...)</span>
							</li>
							<li class="fragment">
								Appeler le compilo de JSP depuis les tests JS ?
								<br><span class="fragment">Hum, hum... :-S<audio src="mi.mp3"></audio></span>
							</li>
							<li class="fragment">
								Traduire la JSP en un autre système de templating ?
								<br><span class="fragment">O_o'<audio src="mi.mp3"></audio></span>
								<span class="fragment">Mais pourquoi ?</span>
							</li>
						</ol>
					</section>

					<section>
						<h2>Aucun lien, fils unique</h2>
						<p>Lodash's _.template()</p>
						<pre class="stretch"><code class="hljs" data-trim style="font-size: .85em;">
// using the "interpolate" delimiter to create a compiled template
var compiled = _.template('hello &lt;%= user %&gt;!');
compiled({ 'user': 'fred' });
// → 'hello fred!'

// using the HTML "escape" delimiter to escape data property values
var compiled = _.template('&lt;b&gt;&lt;%- value %&gt;&lt;/b&gt;');
compiled({ 'value': '&lt;script&gt;' });
// → '&lt;b&gt;&amp;lt;script&amp;gt;&lt;/b&gt;'

// using the "evaluate" delimiter to execute JavaScript and generate HTML
var compiled = _.template('&lt;% _.forEach(users, function(user) { %&gt;&lt;li&gt;&lt;%- user %&gt;&lt;/li&gt;&lt;% }); %&gt;');
compiled({ 'users': ['fred', 'barney'] });
// → '&lt;li&gt;fred&lt;/li&gt;&lt;li&gt;barney&lt;/li&gt;'

// using the ES delimiter as an alternative to the default "interpolate" delimiter
var compiled = _.template('hello ${ user }!');
compiled({ 'user': 'pebbles' });
// → 'hello pebbles!'

// using custom template delimiters
_.templateSettings.interpolate = /{{([\s\S]+?)}}/g;
var compiled = _.template('hello {{ user }}!');
compiled({ 'user': 'mustache' });
// → 'hello mustache!'
						</code></pre>
					</section>
					<section>
						<h2>Et si...</h2>
						<ol>
							<li>
								Interpréteur de JSP en JS, anyone ?
								<br><span>Pas trouvé :-(</span>
							</li>
							<li>
								Appeler le compilo de JSP depuis les tests JS ?
								<br><span>Hum, hum... :-S</span>
							</li>
							<li>
								Traduire la JSP en un autre système de templating ?
								<br><span>O_o'</span>
								<span>Mais pourquoi ?</span>
								<br><span class="fragment">&rightarrow; ça fait beacoup de similitudes quand même :-)</span>
							</li>
						</ol>
					</section>
					<section>
						<h2>Exemple de similitudes</h2>
                        <pre><code class="hljs" data-trim >
&lt;% things.forEach(function(thing) { %&gt;
  &lt;li&gt;&lt;%- thing %&gt;&lt;/li&gt;
  &lt;li&gt;${thing}&lt;/li&gt;
&lt;% }); %&gt;
                        </code></pre>
						<pre><code class="hljs xml" data-trim>
&lt;c:forEach items="${things}" var="thing"&gt;
  &lt;li&gt;&lt;c:out value="${thing}"/&gt;&lt;/li&gt;
  &lt;li&gt;${thing}&lt;/li&gt;
&lt;/c:forEach&gt;
                        </code></pre>
					</section>
				</section>

				<section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>Comment traduire une JSP en template lodash ?</p>
						<p class="fragment">
							Mais bien sûr...
						</p>
						<p class="fragment" style="font-size: 2em; font-weight: bold; color: yellow;">
							des Regex(p) !
						</p>
						<span class="fragment"><audio src="mi.mp3"></audio></span>
						<span class="fragment"><audio src="mi.mp3"></audio></span>
						<span class="fragment"><audio src="mi.mp3"></audio></span>
					</section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>Allez, juste une heure de coding, pour rire !</p>
						<p class="fragment">Bon OK, 4 petites heures plus tard...</p>
					</section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>LE test :-° (1/3)</p>
<pre><code class="hljs" data-trim style="font-size: .9em;">
describe('Jsp Translator', function () {
  it('should translate a big soup of JSP tags', function () {
    var attributes = {bar: 'toto'...};

    var jspPath = path.resolve(__dirname, 'main.jsp');
    var expectedHtml = readAsString(__dirname, 'expected.html'));
    expect(jsp.resolveFile(jspPath, attributes)).to.equal(expectedHtml);
  });
});
</code></pre>
					</section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>LE test :-° (2/3)</p>
<pre class="stretch"><code class="hljs xml" data-trim style="font-size: .85em;">
&lt;%@ page contentType="text/html" %&gt;
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%&gt;
&lt;%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %&gt;

&lt;%-- some comment --%&gt;
&lt;c:choose&gt;
  &lt;c:when test="${myVar != 'someVal'}"&gt;
    &lt;p&gt;should not be shown&lt;/p&gt;
  &lt;/c:when&gt;
  &lt;c:when test="${myVar2 == 'someOtherVal'}"&gt;
    &lt;p&gt;should be shown 1&lt;/p&gt;
  &lt;/c:when&gt;
  &lt;c:otherwise&gt;
    &lt;p&gt;should also not be shown&lt;/p&gt;
  &lt;/c:otherwise&gt;
&lt;/c:choose&gt;
&lt;c:choose&gt;
  &lt;c:when test="${myVar == 'someVal'}"&gt;
    &lt;p&gt;should be shown 2&lt;/p&gt;
  &lt;/c:when&gt;
  &lt;c:when test="${myVar != 'someVal'}"&gt;
    &lt;p&gt;should not be shown&lt;/p&gt;
  &lt;/c:when&gt;
  &lt;c:otherwise&gt;
    &lt;p&gt;should also not be shown&lt;/p&gt;
  &lt;/c:otherwise&gt;
&lt;/c:choose&gt;
&lt;c:choose&gt;
  &lt;c:when test="${false}"&gt;
    &lt;p&gt;should not be shown&lt;/p&gt;
  &lt;/c:when&gt;
  &lt;c:otherwise&gt;
    &lt;p&gt;should be shown 3&lt;/p&gt;
  &lt;/c:otherwise&gt;
&lt;/c:choose&gt;
&lt;form:form modelAttribute="formModel"&gt;
  &lt;c:forEach items="${things}" var="thing"&gt;
    &lt;form:input type="number" path="formModelMember" data-plop="${thing.name}"/&gt;
    &lt;c:if test="${myVar == 'someVal'}"&gt;
      &lt;input type="date" value="${bar}"&gt;
    &lt;/c:if&gt;
    &lt;c:if test="${myVar2 != 'someVal'}"&gt;
      &lt;input type="number" value="42"&gt;
    &lt;/c:if&gt;
  &lt;/c:forEach&gt;
  &lt;c:out value="notavar"/&gt;
  &lt;c:out value="${avar}"/&gt;
  &lt;un:supported jsp="tag"&gt;&lt;/un:supported&gt;
  &lt;a title="&lt;spring:message code="message.code" javascriptEscape="true"/&gt;" href="#"&gt;Link&lt;/a&gt;
  &lt;!-- @include sibling1: --&gt;
  &lt;%@ include file="sibling1.jsp" %&gt;
  &lt;c:set var="anewvar" value="${anoldvar}"/&gt;
  &lt;p&gt;anewvar: ${anewvar}&lt;/p&gt;
  &lt;c:set var="multilineSet"&gt;
    foo
    bar
  &lt;/c:set&gt;
  &lt;p&gt;multilineSet: ${multilineSet}&lt;/p&gt;
  &lt;c:set var="escapedSet"&gt;
    &lt;c:out value="${avar}"/&gt;
  &lt;/c:set&gt;
  &lt;p&gt;escapedSet: ${escapedSet}&lt;/p&gt;
  &lt;!-- jsp:include sibling1: --&gt;
  &lt;jsp:include page="sibling1.jsp"/&gt;
  &lt;c:if test="${empty emptyVar and empty emptyVar2}"&gt;
    &lt;p&gt;I support "empty"!&lt;/p&gt;
  &lt;/c:if&gt;
  &lt;c:if test="${not empty nonEmptyVar}"&gt;
    &lt;p&gt;I support "not empty"!&lt;/p&gt;
  &lt;/c:if&gt;
  &lt;form:radiobutton path="${radioPath}" value="1" id="${radioPath}1"/&gt;
  &lt;c:forEach begin="${one}" end="3" var="idx"&gt;
    &lt;span&gt;${idx}&lt;/span&gt;
  &lt;/c:forEach&gt;
&lt;/form:form&gt;
</code></pre>
					</section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>LE test :-° (3/3)</p>
<pre class="stretch"><code class="hljs xml" data-trim style="font-size: .85em;">
&lt;p&gt;should be shown 1&lt;/p&gt;
&lt;p&gt;should be shown 2&lt;/p&gt;
&lt;p&gt;should be shown 3&lt;/p&gt;
&lt;form modelAttribute="formModel"&gt;
  &lt;input type="number" value="form model member value"  id="formModelMember" name="formModelMember" data-plop="name 1"/&gt;
  &lt;input type="date" value="toto"&gt;
  &lt;input type="number" value="42"&gt;
  &lt;input type="number" value="form model member value"  id="formModelMember" name="formModelMember" data-plop="name 2"/&gt;
  &lt;input type="date" value="toto"&gt;
  &lt;input type="number" value="42"&gt;
  notavar
  A VALUE TO &amp;amp;SCAPE
  &lt;!-- unsupported JSP tag removed: &lt;un:supported jsp="tag"&gt; --&gt;&lt;!-- unsupported JSP tag removed: &lt;/un:supported&gt; --&gt;
  &lt;a title="i18n_message.code" href="#"&gt;Link&lt;/a&gt;
  &lt;!-- @include sibling1: --&gt;
  &lt;p&gt;Text from sibling.jsp with some toto&lt;/p&gt;
  &lt;dl&gt;
    &lt;dt&gt;Param 1&lt;/dt&gt;&lt;dd&gt;static&lt;/dd&gt;
    &lt;dt&gt;Param 2&lt;/dt&gt;&lt;dd&gt;dynamic, resolved&lt;/dd&gt;
  &lt;/dl&gt;
  &lt;p&gt;anewvar: anoldvalue&lt;/p&gt;
  &lt;p&gt;multilineSet: foo
    bar&lt;/p&gt;
  &lt;p&gt;escapedSet: A VALUE TO &amp;amp;SCAPE&lt;/p&gt;
  &lt;!-- jsp:include sibling1: --&gt;
  &lt;p&gt;Text from sibling.jsp with some toto&lt;/p&gt;
  &lt;dl&gt;
    &lt;dt&gt;Param 1&lt;/dt&gt;&lt;dd&gt;&lt;/dd&gt;
    &lt;dt&gt;Param 2&lt;/dt&gt;&lt;dd&gt;&lt;/dd&gt;
  &lt;/dl&gt;
  &lt;p&gt;I support "empty"!&lt;/p&gt;
  &lt;p&gt;I support "not empty"!&lt;/p&gt;
  &lt;input type="radio"  name="someRadioButtonPath" value="1" id="someRadioButtonPath1"/&gt;
  &lt;span&gt;1&lt;/span&gt;
  &lt;span&gt;2&lt;/span&gt;
  &lt;span&gt;3&lt;/span&gt;
&lt;/form&gt;
</code></pre>
					</section>
					<section>
						<h2>Sprechen Sie JSP?</h2>
						<p>Le résultat (~300 lignes)</p>
<pre class="stretch"><code class="hljs" data-trim style="font-size: .85em;">
'use strict';

var fs = require('fs');
var path = require('path');
var _ = require('lodash');

function unwrapElExpression(value) {
  return value.replace(/^\$\{([^}]*?)\}$/, '$1');
}

function resolve(jsp, attributes, context) {
  context = context || {jspDir: __dirname};

  var ATTRIBUTE = /(?:\s+?([\w-]+?=&quot;.*?&quot;))/g;
  var EL_EXPRESSION = /\$\{([^}]*?)\}/g;
  var FORM_INPUT = /(&lt;form:\w+\s+.*?\b)path=&quot;.*?&quot;(.*?\/?&gt;)/g;
  var FORM = /(&lt;\/?)form:/g;
  var INCLUDE_DIRECTIVE = /&lt;%@\s*include\s+file=&quot;(.*?)&quot;\s*%&gt;/g;
  var JSP_DIRECTIVE_OR_COMMENT = /&lt;%(@|--).*?(--)?%&gt;/g;
  var JSP_TAG = /&lt;\/?(\w+:\w+)(\s+[^&gt;]*?)?\s*\/?&gt;/g;

  function readAttributes(str) {
    var attrs = {};

    var res;
    while ((res = ATTRIBUTE.exec(str)) !== null) {
      var kv = res[1].split('=');
      var key = kv[0];
      var value = kv.slice(1).join('=');
      if (value) {
        value = value.replace(/^&quot;(.*?)&quot;$/, '$1');
        attrs[key] = replaceElOperators(value);
      } else {
        attrs[key] = null;
      }
    }

    return attrs;
  }

  function replaceElOperators(jsp) {
    var res;
    var buf = [];
    var idx = 0;

    while ((res = EL_EXPRESSION.exec(jsp)) !== null) {
      buf.push(jsp.substring(idx, res.index));
      buf.push('${', res[1].replace(/\bnot\s+empty\s+/g, '!!')
        .replace(/\bempty\s+/g, '!')
        .replace(/\s+and\s+/, ' && ')
        .replace(/\s+or\s+/, ' || '), '}');

      idx = EL_EXPRESSION.lastIndex;
    }

    buf.push(jsp.substring(idx));

    return buf.join('');
  }

  function replaceFormInputs(jsp) {
    var res;
    var buf = [];
    var idx = 0;

    while ((res = FORM_INPUT.exec(jsp)) !== null) {
      buf.push(jsp.substring(idx, res.index));
      buf.push(res[1]);

      var attrs = readAttributes(res[0]);

      if (!attrs.id) {
        buf.push(' id=&quot;', attrs.path, '&quot;');
      }
      if (!attrs.name) {
        buf.push(' name=&quot;', attrs.path, '&quot;');
      }
      buf.push(res[2]);
      idx = FORM_INPUT.lastIndex;
    }

    buf.push(jsp.substring(idx));

    return buf.join('');
  }

  function resolveInclude(file, attrs) {
    var filePath = path.resolve(context.jspDir, file);
    return resolveFile(filePath, attrs);
  }

  function replaceJspTags(jsp) {
    var res;
    var buf = [];
    var bufBackup;
    var idx = 0;

    var currentJspParams, currentJspPageToInclude, currentChoose, currentModelAttribute;

    function jspInclude() {
      var inclusionAttrs = _.assign({
        param: currentJspParams
      }, attributes);

      var str = resolveInclude(currentJspPageToInclude, inclusionAttrs);

      currentJspPageToInclude = null;
      currentJspParams = null;
      return str;
    }

    var STRATEGIES = {
      DEFAULT: {
        open: function (buf, res) {
          buf.push('&lt;!-- unsupported JSP tag removed: ', res[0], ' --&gt;');
        },
        close: function (buf, res) {
          buf.push('&lt;!-- unsupported JSP tag removed: ', res[0], ' --&gt;');
        }
      },
      'c:choose': {
        open: function () {
          currentChoose = {};
        },
        close: function () {
          buf.push('&lt;% } %&gt;');
        }
      },
      'c:otherwise': {
        open: function (buf) {
          buf.push('&lt;% } else { %&gt;');
        },
        close: function (buf) {
        }
      },
      'c:when': {
        open: function (buf, res, attrs) {
          if (currentChoose.firstWhenPassed) {
            buf.push('&lt;% } else if (', unwrapElExpression(attrs.test), ') { %&gt;');
          } else {
            buf.push('&lt;% if (', unwrapElExpression(attrs.test), ') { %&gt;');
          }
          currentChoose.firstWhenPassed = true;
        },
        close: function (buf) {
        }
      },
      'c:forEach': {
        open: function (buf, res, attrs) {
          var items;
          if (attrs.items) {
            items = unwrapElExpression(attrs.items);
          } else {
            items = '_.range(' + unwrapElExpression(attrs.begin) + ', ' + unwrapElExpression(attrs.end) + ' + 1)';
          }
          buf.push('&lt;% ', items, '.forEach(function (', attrs.var, ') { %&gt;');
        },
        close: function (buf) {
          buf.push('&lt;% }); %&gt;');
        }
      },
      'c:if': {
        open: function (buf, res, attrs) {
          buf.push('&lt;% if (', unwrapElExpression(attrs.test), ') { %&gt;');
        },
        close: function (buf) {
          buf.push('&lt;% } %&gt;');
        }
      },
      'c:set': {
        open: function (buf, res, attrs) {
          if (attrs.value) {
            if (attrs.value.indexOf('${') === 0) {
              buf.push('&lt;% var ', attrs.var, ' = ', unwrapElExpression(attrs.value), '; %&gt;');
            } else {
              buf.push('&lt;% var ', attrs.var, ' = &quot;', attrs.value, '&quot;; %&gt;');
            }
          } else {
            buf.push('&lt;% var ', attrs.var, ' = ');
          }
        },
        close: function (buf, res, setContent) {
          if (!setContent) {
            return;
          }

          setContent = setContent.trim();

          var match = setContent.match(/^&lt;%-\s*(.*?)\s*%&gt;$/);
          if (match) {
            buf.push('_.escape(', match[1], '); %&gt;');
          } else {
            match = setContent.match(/^&lt;%=?\s*(.*?)\s*%&gt;$/);
            if (match) {
              buf.push(match[1], '; %&gt;');
            } else {
              buf.push('&quot;', setContent.replace(/\n/g, '\\n'), '&quot;; %&gt;');
            }
          }
        }
      },
      'c:out': {
        open: function (buf, res, attrs) {
          if (attrs.value.indexOf('${') === 0) {
            buf.push('&lt;%- ', unwrapElExpression(attrs.value), ' %&gt;');
          } else {
            buf.push(attrs.value);
          }
        }
      },
      'form:form': {
        open: function (buf, res, attrs) {
          if (attrs.modelAttribute) {
            currentModelAttribute = attrs.modelAttribute;
          }
          // handled later
          buf.push(res[0]);
        },
        close: function (buf, res) {
          currentModelAttribute = null;
          // handled later
          buf.push(res[0]);
        }
      },
      'form:input': {
        open: function (buf, res, attrs) {
          if (attrs.path) {
            var path = attrs.path;
            if (currentModelAttribute) {
              if (path.indexOf('${') === 0) {
                path = currentModelAttribute + '[' + unwrapElExpression(path) + ']';
              } else {
                path = currentModelAttribute + '.' + path;
              }
            }
            var value = attrs.value;
            if (value) {
              buf.push(res[0]);
            } else {
              if (path.indexOf('${') === 0) {
                value = '';  // not implemented, too complex
              } else {
                value = '${' + path + '}';
              }
              buf.push(res[0].replace(/\bpath=/, 'value=&quot;' + value + '&quot; path='));
            }
          }
          else {
            // handled later
            buf.push(res[0]);
          }
        },
        close: function (buf, res) {
          // handled later
          buf.push(res[0]);
        }
      },
      'form:radiobutton': {
        open: function (buf, res, attrs) {
          res[0] = res[0].replace('radiobutton', 'input type=&quot;radio&quot;');
          STRATEGIES['form:input'].open(buf, res, attrs);
        },
        close: function (buf, res) {
          STRATEGIES['form:input'].close(buf, res);
        }
      },
      'jsp:include': {
        open: function (buf, res, attrs, selfClosing) {
          currentJspPageToInclude = attrs.page;
          currentJspParams = {};
          if (selfClosing) {
            buf.push(jspInclude());
          }
        },
        close: function (buf) {
          buf.push(jspInclude());
        }
      },
      'jsp:param': {
        open: function (buf, res, attrs) {
          currentJspParams[attrs.name] = attrs.value;
        }
      },
      'spring:message': {
        open: function (buf, res, attrs) {
          buf.push('i18n_' + attrs.code);
        }
      }
    };

    while ((res = JSP_TAG.exec(jsp)) !== null) {
      buf.push(jsp.substring(idx, res.index));

      var tag = res[0];
      var tagName = res[1];

      var closing = tag.indexOf('&lt;/') === 0;
      if (!closing) {
        var selfClosing = tag.indexOf('/&gt;') === tag.length - 2;
        var attrs = readAttributes(tag);

        var strategy = STRATEGIES[tagName] || STRATEGIES.DEFAULT;
        var open = strategy.open || STRATEGIES.DEFAULT.open;

        open(buf, res, attrs, selfClosing);
        if (tagName === 'c:set' && !selfClosing) {
          bufBackup = buf;
          buf = [];
        }
      }
      else {
        var strategy = STRATEGIES[tagName] || STRATEGIES.DEFAULT;
        var close = strategy.close || STRATEGIES.DEFAULT.close;

        if (bufBackup) {
          var content = buf.join('');
          buf = bufBackup;
          bufBackup = null;
          close(buf, res, content);
        } else {
          close(buf, res);
        }
      }
      idx = JSP_TAG.lastIndex;
    }

    buf.push(jsp.substring(idx));

    return buf.join('');
  }

  function replaceIncludes(jsp) {
    var res;
    var buf = [];
    var idx = 0;

    while ((res = INCLUDE_DIRECTIVE.exec(jsp)) !== null) {
      buf.push(jsp.substring(idx, res.index));
      buf.push(resolveInclude(res[1], attributes));
      idx = INCLUDE_DIRECTIVE.lastIndex;
    }

    buf.push(jsp.substring(idx));

    return buf.join('');
  }

  function convert(jsp) {
    jsp = replaceElOperators(jsp);
    jsp = replaceJspTags(jsp);
    jsp = replaceFormInputs(jsp);
    jsp = jsp.replace(FORM, '$1');
    jsp = replaceIncludes(jsp);

    return jsp.replace(JSP_DIRECTIVE_OR_COMMENT, '');
  }

  return _.template(convert(jsp))(attributes)
    .replace(/\n+\s*\n+/g, '\n');
}

function resolveFile(jspFile, attributes, jspDir) {
  var jsp = fs.readFileSync(jspFile).toString();
  return resolve(jsp, attributes, {jspDir: jspDir || path.dirname(jspFile)});
}

module.exports = {
  resolve: resolve,
  resolveFile: resolveFile
};
</code></pre>
					</section>
					<section>
                        <p>Résumé :</p>
<pre class="stretch"><code class="hljs" data-trim style="font-size: .85em;">
function unwrapElExpression(value) {}

function resolve(jsp, attributes, context) {
  context = context || {jspDir: __dirname};

  var ATTRIBUTE = /(?:\s+?([\w-]+?=&quot;.*?&quot;))/g;
  var EL_EXPRESSION = /\$\{([^}]*?)\}/g;
  var FORM_INPUT = /(&lt;form:\w+\s+.*?\b)path=&quot;.*?&quot;(.*?\/?&gt;)/g;
  var FORM = /(&lt;\/?)form:/g;
  var INCLUDE_DIRECTIVE = /&lt;%@\s*include\s+file=&quot;(.*?)&quot;\s*%&gt;/g;
  var JSP_DIRECTIVE_OR_COMMENT = /&lt;%(@|--).*?(--)?%&gt;/g;
  var JSP_TAG = /&lt;\/?(\w+:\w+)(\s+[^&gt;]*?)?\s*\/?&gt;/g;

  function readAttributes(str) {}

  function replaceElOperators(jsp) {}

  function replaceFormInputs(jsp) {}

  function resolveInclude(file, attrs) {}

  function replaceOtherJspTags(jsp) {
    /* ... */

    var STRATEGIES = {
      DEFAULT: {
        open: function (buf, res, attrs, selfClosing) {
          buf.push('&lt;!-- unsupported JSP tag removed: ', res[0], ' --&gt;');
        },
        close: function (buf, res) {
          buf.push('&lt;!-- unsupported JSP tag removed: ', res[0], ' --&gt;');
        }
      },
      'c:choose': {},
      'c:otherwise': {},
      'c:when': {},
      'c:forEach': {},
      'c:if': {},
      'c:set': {},
      'c:out': {},
      'form:form': {},
      'form:input': {},
      'form:radiobutton': {},
      'jsp:include': {},
      'jsp:param': {},
      'spring:message': {}
    };

    while ((res = JSP_TAG.exec(jsp)) !== null) {
      buf.push(jsp.substring(idx, res.index));

      var closing = res[0].indexOf('&lt;/') === 0;
      if (!closing) {
        var selfClosing = res[0].indexOf('/&gt;') === res[0].length - 2;
        var attrs = readAttributes(res[0]);

        var strategy = STRATEGIES[res[1]] || STRATEGIES.DEFAULT;
        var open = strategy.open || STRATEGIES.DEFAULT.open;
        open(buf, res, attrs, selfClosing);
      }
      else {
        var strategy = STRATEGIES[res[1]] || STRATEGIES.DEFAULT;
        var close = strategy.close || STRATEGIES.DEFAULT.close;
        close(buf, res);
      }
      idx = JSP_TAG.lastIndex;
    }

    buf.push(jsp.substring(idx));

    return buf.join('');
  }

  function replaceIncludes(jsp) {}

  function convert(jsp) {
    jsp = replaceOtherJspTags(jsp);
    jsp = replaceFormInputs(jsp);
    jsp = jsp.replace(FORMS, '$1');
    jsp = replaceIncludes(jsp);

    return jsp.replace(JSP_DIRECTIVE_OR_COMMENT, '');
  }

  return _.template(convert(jsp))(attributes)
    .replace(/\n+\s*\n+/g, '\n');
}

function resolveFile(jspFile, attributes, jspDir) {
    var jsp = fs.readFileSync(jspFile).toString();
    return resolve(jsp, attributes, {jspDir: jspDir || path.dirname(jspFile)});
}
</code></pre>
					</section>
				</section>

				<section>
					<h2>Hop, plus qu'à écrire des tests !</h2>
					<p>Démo</p>
				</section>

				<section>
					<h2>Conclusions</h2>
					<ul>
						<li class="fragment">C'est utile ? Donc ce n'est peut-être pas si stupide !</li>
						<li class="fragment">Si vous êtes dans la même situation...</li>
					</ul>
				</section>

				<section>
					<h2>Merci pour la séance !</h2>
					<p class="fragment">(Au fait, vous en pensez quoi : bonne ou <span class="fragment">mauvaise idée<audio src="mi.mp3"></audio></span> ?)</p>
				</section>

                <section>
                    <small>Source du jingle : <a href="https://www.youtube.com/watch?v=GIQQaXfqJFU">https://www.youtube.com/watch?v=GIQQaXfqJFU</a> (oué, aucune pitié)</small>
                </section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
//					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
//					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

		<script>
			function playCurrentFragment() {
				[].slice.call(document.querySelectorAll('.fragment')).forEach(function (fragment) {
					var audio = fragment.querySelector('audio');
					if (audio) {
						if (fragment.classList.contains('current-fragment')) {
							audio.play();
						}
						else {
							audio.pause();
						}
					}
				});
			}
			Reveal.addEventListener('fragmentshown', playCurrentFragment);
			Reveal.addEventListener('fragmenthidden', playCurrentFragment);
		</script>
	</body>
</html>
